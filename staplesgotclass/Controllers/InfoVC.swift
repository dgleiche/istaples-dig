//
//  InfoVC.swift
//  staplesgotclass
//
//  Created by Dylan on 5/30/16.
//  Copyright Â© 2016 Dylan Diamond. All rights reserved.
//

import UIKit
import MessageUI

class InfoVC: UITableViewController, MFMailComposeViewControllerDelegate {
    @IBOutlet var versionNumberLabel: UILabel!
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.navigationController?.navigationBar.barTintColor = UIColor(red:0.13, green:0.42, blue:0.81, alpha:1.0)
        self.navigationController?.navigationBar.isTranslucent = false
        self.navigationController?.navigationBar.tintColor = UIColor.white
        self.navigationController?.navigationBar.titleTextAttributes = [ NSFontAttributeName: UIFont(name: "AppleSDGothicNeo-UltraLight", size: 15)!, NSForegroundColorAttributeName: UIColor.white]
        UIApplication.shared.statusBarStyle = .lightContent
        let backButton = UIBarButtonItem(title: " ", style: .plain, target: nil, action: nil)
        
        self.navigationItem.backBarButtonItem = backButton

        self.navigationItem.title = "INFO"
        
        self.versionNumberLabel.text = Bundle.main.object(forInfoDictionaryKey: "CFBundleShortVersionString") as? String
    }
    
    func logout() {
        self.dismiss(animated: true, completion: nil)
        NotificationCenter.default.post(name: Notification.Name(rawValue: "logout"), object: nil)
    }
    
    func sendMail(_ address: String) {
        let toRecipents = [address]
        let mc: MFMailComposeViewController = MFMailComposeViewController()
        mc.mailComposeDelegate = self
        mc.setToRecipients(toRecipents)
        mc.setSubject("iStaples App")
        mc.setMessageBody("\n\nFrom,\n\(UserManager.sharedInstance!.currentUser.name)", isHTML: false)
        
        self.present(mc, animated: true, completion: nil)
    }
    
    func mailComposeController(_ controller:MFMailComposeViewController, didFinishWith result:MFMailComposeResult, error:Error?) {
        switch result {
        case MFMailComposeResult.cancelled:
            print("Mail cancelled")
        case .saved:
            print("Mail saved")
        case .sent:
            print("Mail sent")
        case .failed:
            print("Mail sent failure: \(error?.localizedDescription)")
        default:
            break
        }
        self.dismiss(animated: true, completion: nil)
    }
    
    //MARK: Table View Functions
    
    override func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        if indexPath.section == 1 && indexPath.row == 0 {
            UIApplication.shared.openURL(URL(string: "http://staplesgotclass.com")!)
        }
        else if indexPath.section == 2 {
            switch indexPath.row {
            case 0:
                print("Email Diamond")
                sendMail("dylan@dcdwebdesign.com")
            case 1:
                print("Email Gleicher")
                sendMail("dgleiche@me.com")
            case 2:
                print("Email Neal")
                sendMail("ns51387@students.westport.k12.ct.us")
            default:
                break
            }
        }
        
        else if indexPath.section == 3 {
            //Log out button
            print("logout")
            logout()
        }
        
        self.tableView.deselectRow(at: indexPath, animated: true)
    }
    
    //MARK: Navigation
    
    
    @IBAction func donePressed(_ sender: AnyObject) {
        self.dismiss(animated: true, completion: nil)
    }
    
    
    //Set the text for the two info things
    
    let aboutText = "iStaples allows students of Staples High School to track their classes and their classmates. This app is designed to be easier and more mobile than the web interface, staplesgotclass.com. You can also view your friends' schedules, along with their classmates."
    
    let securityText = "This app works by logging you in to our servers through a token generated by a Google OAuth login. As Google OAuth is utilized, passwords are NOT NOR COULD BE at any time stored or accessed by this app. Google handles all credentials, thus the security of this app is the security of a Google log in. \n \nBy using this app, you agree that anonymous analytic data may be collected to help improve future use of iStaples."
    
    override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
        if segue.identifier == "aboutSegue" {
            let newView = segue.destination as! AboutVC
            
            newView.title = "About SHS Got Class"
            newView.text = aboutText
        }
        
        else if segue.identifier == "securitySegue" {
            let newView = segue.destination as! AboutVC
            
            newView.title = "Security Information"
            newView.text = securityText
        }
    }
}
